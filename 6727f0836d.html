<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Invoice Layout</title>
        <link rel="stylesheet" href="/styles.css" />
        <style>
            @media print {
                /* Hide everything except the invoice container */
                body {
                    margin: 0; /* Remove default margin */
                    padding: 0; /* Remove default padding */
                    height: 100vh; /* Full height */
                    display: flex; /* Use flexbox to center */
                    align-items: flex-start; /* Start from the top */
                    justify-content: center; /* Center horizontally */
                }

                body * {
                    visibility: hidden; /* Hide all other elements */
                }

                #invoice-container,
                #invoice-container * {
                    visibility: visible; /* Show only the invoice container */
                }

                #invoice-container {
                    position: absolute; /* Use absolute positioning */
                    top: 0; /* Start at the top */
                    left: 50%; /* Center horizontally */
                    transform: translateX(-50%); /* Adjust for centering */
                    width: 80%; /* Adjust width as necessary */
                    max-height: 100vh; /* Ensure it fits within the viewport */
                    margin: 0; /* Remove margin */
                    padding: 0; /* Remove padding */
                    box-sizing: border-box; /* Include padding and borders in width/height */
                }
                .bullet-points-container {
                    margin-left: 50px;
                }
                .date-time {
                    padding-left: 50px;
                }
                #invoiceUserName2nd {
                    padding-right: 50px;
                }
            }
        </style>
    </head>
    <body>
        <div class="content-container">
            <!-- Form for Editing Fields -->
            <div class="form-container">
                <h2>Edit Invoice Details</h2>
                <form id="invoiceForm">
                    <label for="date">Date:</label>
                    <input
                        type="date"
                        id="date"
                        name="date"
                        value="2024-11-10"
                        oninput="updateInvoice()" />

                    <label for="time">Time:</label>
                    <input
                        type="time"
                        id="time"
                        name="time"
                        value="11:24"
                        oninput="updateInvoice()" />
                    <label for="receiptNumber">Receipt Number:</label>
                    <input
                        type="text"
                        id="receiptNumber"
                        name="receiptNumber"
                        value="34060204287947437"
                        oninput="updateInvoice()" />

                    <label for="amount">Amount:</label>
                    <input
                        type="number"
                        id="amount"
                        name="amount"
                        step="0.01"
                        value="470.5"
                        oninput="updateInvoice()" />
                    <label for="inputOwnerName">Owner Name:</label>
                    <input
                        type="text"
                        id="inputOwnerName"
                        name="inputOwnerName"
                        value="makrm"
                        oninput="updateInvoice()" />

                    <label for="inputVehicleNumber">Vehicle Number:</label>
                    <input
                        type="text"
                        id="inputVehicleNumber"
                        name="inputVehicleNumber"
                        value="1585 Oman"
                        oninput="updateInvoice()" />

                    <label for="userName">User Name:</label>
                    <input
                        type="text"
                        id="userName"
                        name="userName"
                        value="Saned270"
                        oninput="updateInvoice()" />

                    <label for="inputVoucherName">Voucher Name:</label>
                    <input
                        type="text"
                        id="inputVoucherName"
                        name="inputVoucherName"
                        value="0648295865472852"
                        oninput="updateInvoice()" />

                    <button type="button" onclick="printInvoice()">
                        Print Invoice
                    </button>
                </form>
            </div>

            <div class="invoice-container" id="invoice-container">
                <!-- Barcode Section -->
                <div class="barcode-container">
                    <img
                        src="images/barcode.png"
                        alt="Barcode"
                        class="barcode" />
                </div>
                <!-- Logo Section -->
                <div class="logo-row">
                    <img
                        src="images/leftlogo.png"
                        alt="Left Logo"
                        class="logo" />
                    <img
                        src="images/rightlogo.png"
                        alt="Right Logo"
                        class="logo" />
                </div>

                <div class="text-row">
                    <div class="text-left">
                        <p>حكومة الشارقة</p>
                        <p>هيئة الطرق والمواصلات</p>
                        <p>نظام التعرفة المرورية للشاحنات</p>
                    </div>
                    <div class="text-right">
                        <p>حكومة الشارقة</p>
                        <p>دائرة المالية المركزية</p>
                        <p>نظام الدفع الرقمي تحصيل</p>
                    </div>
                </div>

                <div class="new-text-row">
                    <p class="arabic-text">فاتورة ضريبية</p>
                    <p class="english-text">Tax Invoice</p>
                    <p class="number-text">
                        <strong>TRN 100531353900003</strong>
                    </p>
                </div>

                <div class="dashed-line"></div>
                <!-- Time and Date Section -->
                <div class="time-date-row">
                    <div class="time-left">
                        <span>Time</span>
                        <span id="invoiceTime">11:24 AM</span>
                    </div>
                    <div class="date-left">
                        <span>Date</span>
                        <span id="invoiceDate">11/10/2024</span>
                    </div>
                    <div class="time-arabic"><span>الـتـاريـخ</span></div>
                </div>

                <!-- New Rows Section -->
                <div class="form-rows">
                    <div class="row">
                        <div class="left-column">Receipt number</div>
                        <div class="middle-column" id="invoiceReceiptNumber">
                            34060204287947437
                        </div>
                        <div class="right-column">رقم الاتصال</div>
                    </div>
                    <div class="row">
                        <div class="left-column">Amount</div>
                        <div class="middle-column" id="invoiceAmount">
                            470.5
                        </div>
                        <div class="right-column">المبلغ</div>
                    </div>
                    <div class="row">
                        <div class="left-column">Owner Name</div>
                        <div class="middle-column" id="ownerName">makrm</div>
                        <div class="right-column">اسم المالك</div>
                    </div>
                    <div class="row">
                        <div class="left-column">Service</div>
                        <div class="middle-column servicemiddle">
                            رسوم عنور شاخية مع مقطورة نقدي
                        </div>
                        <div class="right-column">نوع الخدمة</div>
                    </div>
                    <div class="row">
                        <div class="left-column">Vehicle Number</div>
                        <div class="middle-column" id="vehicleNumber">
                            1585 Oman
                        </div>
                        <div class="right-column">رقم المركبة</div>
                    </div>
                    <div class="row">
                        <div class="left-column">User Name</div>
                        <div class="middle-column" id="invoiceUserName">
                            Saned270
                        </div>
                        <div class="right-column">اسم المستخدم</div>
                    </div>
                    <div class="row">
                        <div class="left-column">Voucher Name</div>
                        <div class="middle-column" id="voucherName">
                            0648295865472852
                        </div>
                        <div class="right-column">رقم الإيصال الالكتروني</div>
                    </div>
                </div>
                <!-- QR Code Section and Bullet Points remain the same -->
                <div class="qr-code-container">
                    <img
                        id="qr-code-img"
                        src="https://quickchart.io/qr?text=http://localhost:3000/CustomerPortal/qr/v?&centerImageUrl=https://raw.githubusercontent.com/asadali27232/FYP/refs/heads/main/logo.jpg&centerImageSizeRatio=0.5&size=200&margin=0"
                        alt="QR Code"
                        class="qr-code" />
                    <div class="qr-text">
                        <div class="date-time">11/10/2024 11:24:25 AM</div>
                        <div class="english-text" id="invoiceUserName2nd">
                            Saned270
                        </div>
                    </div>
                </div>
                <!-- Bullet Points Section -->
                <div class="bullet-points-container">
                    <div class="bullet-points">
                        <ul class="bullets">
                            <li>
                                <div class="bullet-item">
                                    *
                                    <span class="english"
                                        >This receipt has been printed based on
                                        the data entered in digital payment
                                        system Tahseel</span
                                    >

                                    <span class="arabic"
                                        >تمت طباعة هذا الإيصال اعتماداً على
                                        البيانات المدخلة بنظام الدفع الرقمي
                                        تحصيل</span
                                    >*
                                </div>
                            </li>
                            <li>
                                <div class="bullet-item">
                                    *
                                    <span class="english"
                                        >Photocopied or unsigned and un receipts
                                        are not considered valid.</span
                                    >
                                    <span class="arabic"
                                        >لا يعد بالإيصالات المنسوخة أو عبر
                                        الموقعة والمختومة</span
                                    >*
                                </div>
                            </li>
                            <li>
                                <div class="bullet-item">
                                    *
                                    <span class="english"
                                        >Any erasure or alteration in this
                                        document invalidates it</span
                                    >
                                    <span class="arabic"
                                        >كل قشط أو تغيير في هذه الوثيقة
                                        يلغيها</span
                                    >
                                    *
                                </div>
                            </li>
                            <li>
                                <div class="bullet-item">
                                    *
                                    <span class="english"
                                        >Please verify receipt details by
                                        scanning QR code</span
                                    >

                                    <span class="arabic"
                                        >يرجى مطابقة بيانات الايصال عن طريق مسح
                                        رمر الاستجابة السريعة</span
                                    >*
                                </div>
                            </li>
                            <li>
                                <div class="bullet-item">
                                    *
                                    <span class="english"
                                        >Please make sure after you scan QR code
                                        that the browser address is
                                        tahseel.gov.ae</span
                                    >

                                    <span class="arabic">
                                        tahseel.gov.ae يرجى التأكد بعد مسح رمز
                                        الاستجابة السريعة ان عنوان المتصفح
                                        هو</span
                                    >
                                    *
                                </div>
                            </li>
                            <li>
                                <div class="bullet-item">
                                    *
                                    <span class="english"
                                        >To review the approved fees, please
                                        refer to Executive Council Decision No.
                                        10 for the year 2022</span
                                    >
                                    <span class="arabic"
                                        >المراجعة الرسوم المعتمدة يرجى مراجعة
                                        قرار المجلس التنفيذي رقم 10 لسنة
                                        2022</span
                                    >
                                    *
                                </div>
                            </li>
                            <li>
                                <div class="bullet-item">
                                    *
                                    <span class="english">
                                        Please keep the receipt for auditing
                                        purposes.</span
                                    >
                                    <span class="arabic"
                                        >يرجي الاحتفاظ بالايصال الدواعي
                                        التطليق</span
                                    >
                                    *
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <script>
            function formatTime(date) {
                const hours = date.getHours();
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const formattedHours = hours % 12 || 12;
                return `${formattedHours}:${minutes} ${ampm}`;
            }

            function formatDate(date) {
                const day = (date.getMonth() + 1).toString().padStart(2, '0');
                const month = date.getDate().toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${month}/${day}/${year}`;
            }

            function updateInvoice() {
                const dateValue = new Date(
                    document.getElementById('date').value
                );
                const timeValue = document.getElementById('time').value;
                const formattedDate = formatDate(dateValue);
                const formattedTime = formatTime(
                    new Date(`1970-01-01T${timeValue}`)
                );

                // Update the invoice date and time
                document.getElementById('invoiceDate').innerText =
                    formattedDate;
                document.getElementById('invoiceTime').innerText =
                    formattedTime;

                // Update the amount and receipt number
                document.getElementById('invoiceAmount').innerText =
                    document.getElementById('amount').value;
                document.getElementById('invoiceReceiptNumber').innerText =
                    document.getElementById('receiptNumber').value;

                // Update the user name in the first and second instances
                const userNameValue = document.getElementById('userName').value;
                document.getElementById('invoiceUserName').innerText =
                    userNameValue;
                document.getElementById('invoiceUserName2nd').innerText =
                    userNameValue;

                // Update the QR code date and time
                document.querySelector(
                    '.date-time'
                ).innerText = `${formattedDate} ${formattedTime}`;

                // Update the vehicle number
                document.getElementById('vehicleNumber').innerText =
                    document.getElementById('inputVehicleNumber').value;

                // Update the voucher name
                document.getElementById('voucherName').innerText =
                    document.getElementById('inputVoucherName').value;

                // Update the owner name
                document.getElementById('ownerName').innerText =
                    document.getElementById('inputOwnerName').value;
            }

            async function saveInvoice() {
                // Prepare the invoice data
                const invoiceData = {
                    date: document.getElementById('invoiceDate').innerText,
                    time: document.getElementById('invoiceTime').innerText,
                    receiptNumber: document.getElementById(
                        'invoiceReceiptNumber'
                    ).innerText,
                    amount: document.getElementById('invoiceAmount').innerText,
                    vehicleNumber:
                        document.getElementById('vehicleNumber').innerText,
                    userName:
                        document.getElementById('invoiceUserName').innerText,
                    voucherName:
                        document.getElementById('voucherName').innerText,
                    date_time: document.querySelector('.date-time').innerText,
                    userName2nd:
                        document.getElementById('invoiceUserName2nd').innerText,
                    ownerName: document.getElementById('ownerName').innerText,
                };

                try {
                    // Send the invoice data to the backend
                    const response = await fetch(
                        'http://localhost:3000/api/invoices',
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(invoiceData),
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        const invoiceId = data.id; // Get the saved invoice ID

                        // Update the QR code URL with the new ID
                        updateQrUrl(invoiceId);

                        alert('Invoice saved successfully!');
                    } else {
                        alert('Error saving invoice');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving invoice');
                }
            }

            // Update the QR code URL based on the invoice ID
            function updateQrUrl(invoiceId) {
                const qrCodeUrl = `https://quickchart.io/qr?text=http://localhost:3000/CustomerPortal/qr/v?id=${invoiceId}&centerImageUrl=https://raw.githubusercontent.com/asadali27232/FYP/refs/heads/main/logo.jpg&centerImageSizeRatio=0.5&size=200&margin=0`;

                // Update the QR code image
                document.getElementById('qr-code-img').src = qrCodeUrl;
            }
            function printInvoice() {
                updateInvoice(); // Ensure everything is updated before printing
                saveInvoice(); // Save the invoice before printing
                window.print();
            }
        </script>
    </body>
</html>
